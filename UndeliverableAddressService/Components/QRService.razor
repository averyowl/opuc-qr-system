@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.AspNetCore.Components.Web
@using UndeliverableAddressService.Data
@using UndeliverableAddressService.Models
@page "/qrs" // aka qr-service
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject IRecipientRepository RecipientRepository

<h3>QR Scan Result</h3>

@if (!string.IsNullOrEmpty(ErrorMessage)) {
    <div class="alert alert-danger">@ErrorMessage</div>
}
else if (RecipientId.HasValue && ProgramType.HasValue)
{
    @if (RecipientInfo is not null)
    {
        <div class="alert alert-success">
            Program: @ProgramType<br/>
            Recipient ID: @RecipientId<br/>
            Name: @RecipientInfo.FirstName @RecipientInfo.MiddleName @RecipientInfo.LastName<br/>
            Address: @RecipientInfo.AddressLine1, @RecipientInfo.City, @RecipientInfo.StateCode @RecipientInfo.ZIPCode<br/>
            Bad Address: @(RecipientInfo.FlagBadAddress == 1 ? "Yes" : "No")
        </div>
        <button class="btn btn-primary" @onclick="InvalidateRecipient" disabled="@IsProcessing">@ButtonText</button>
        @if (!string.IsNullOrEmpty(ActionMessage))
        {
            <div class="alert alert-info mt-2">@ActionMessage</div>
        }
    }
    else
    {
        <div class="alert alert-warning">@ProgramType recipient id @RecipientId not found.</div>
    }
}

@code {
    private int? RecipientId { get; set; }
    private RecipientSource? ProgramType { get; set; }
    private string? ErrorMessage { get; set; }
    private Recipient? RecipientInfo { get; set; }
    private bool IsProcessing { get; set; }
    private string ButtonText => IsProcessing ? "Processing..." : "Invalidate Recipient Address";
    private string? ActionMessage { get; set; }


    protected override async Task OnInitializedAsync() {
        try {
            // Example URL: http://localhost:5000/qr-service/?id=123&prog=OTAP

            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);

            if (!query.TryGetValue("prog", out var programValue) || 
                !Enum.TryParse<RecipientSource>(programValue.FirstOrDefault(), true, out var prog))
            {
                ErrorMessage = "Program type is empty or invalid (OTAP/TDAP).";
                return;
            }

            if (!query.TryGetValue("id", out var idValue) || 
                !int.TryParse(idValue.FirstOrDefault(), out var recipientId))
            {
                ErrorMessage = "Recipient ID is empty or invalid.";
                return;
            }

            ProgramType = prog;
            RecipientId = recipientId;
            RecipientInfo = await RecipientRepository.GetRecipientByIDAndSource(recipientId, prog);
        }
        catch (Exception ex) {
            ErrorMessage = $"Error processing QR code: {ex.Message}";
        }
    }

    private async Task InvalidateRecipient()
    {
        if (!RecipientId.HasValue || !ProgramType.HasValue)
        {
            Console.WriteLine("RecipientId or ProgramType is not set.");
            return;
        }

        IsProcessing = true;
        ActionMessage = null;
        StateHasChanged();

        try
        {
            var success = await RecipientRepository.InsertRecipientEvent(
                recipientId: RecipientId.Value,
                source: ProgramType.Value,
                eventTypeCode: "UNDL",
                note: $"Address invalidated via QR Service.",
                updatedBy: "QR-SERVICE"
            );

            ActionMessage = success 
                ? "Recipient address successfully invalidated." 
                : "Failed to invalidate recipient address. Please try again.";
        }
        catch (Exception ex)
        {
            ActionMessage = $"Error: {ex.Message}";
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }
}

