@using Microsoft.AspNetCore.WebUtilities
@page "/qr-service"
@inject NavigationManager Navigation

<h3>QR Scan Result</h3>

@if (!string.IsNullOrEmpty(ErrorMessage)) {
    <div class="alert alert-danger">@ErrorMessage</div>
}
else if (RecipientId.HasValue && ProgramType.HasValue)
{
    <div class="alert alert-success">
        Program: @ProgramType<br/>
        Recipient ID: @RecipientId
        <!-- Now you can use this ID to fetch user data, etc. -->
    </div>
}

@code {
    private int? RecipientId { get; set; }
    private RecipientSource? ProgramType { get; set; }
    private string? ErrorMessage { get; set; }

    private enum RecipientSource
    {
        OTAP,
        TDAP
    }

    protected override void OnInitialized() {
        try {
            // Example URL: http://localhost:5000/qr-service/?id=123&program=OTAP

            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);

            if (!query.TryGetValue("program", out var programValue) || 
                !Enum.TryParse<RecipientSource>(programValue, true, out var program))
            {
                ErrorMessage = "Program type is empty or invalid (OTAP/TDAP).";
                return;
            }

            if (!query.TryGetValue("id", out var idValue) || 
                !int.TryParse(idValue.FirstOrDefault(), out var recipientId))
            {
                ErrorMessage = "Recipient ID is empty or invalid.";
                return;
            }

            ProgramType = program;
            RecipientId = recipientId;
        }
        catch (Exception ex) {
            ErrorMessage = $"Error processing QR code: {ex.Message}";
        }
    }
}

